name: Build WAR (Gradle) & Push Docker to ECR

on:
  push:
    branches:
      - feat/refactor-hyebin     # 필요 시 main/develop 추가
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: homebuddy
  IMAGE_TAG_LATEST: latest
  IMAGE_TAG_SHA: sha-${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Temurin JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Gradle 8.10.2 (CLI)
        run: |
          curl -sL https://services.gradle.org/distributions/gradle-8.10.2-bin.zip -o gradle.zip
          unzip -q gradle.zip
          echo "$PWD/gradle-8.10.2/bin" >> $GITHUB_PATH

      # 1) backend 프로젝트에서 WAR 빌드
      - name: Build WAR with Gradle
        working-directory: backend
        run: |
          gradle --no-daemon clean war -x test

      # 2) 사후 패치: WAR(zip) 내부에서 중복 JAR만 삭제 (재패키징 불필요)
      - name: Strip duplicated starter from WAR (post-process)
        working-directory: backend
        shell: bash
        run: |
          set -e
          WAR_PATH="$(ls build/libs/*.war | head -n1)"
          echo "Target WAR: $WAR_PATH"

          command -v zip >/dev/null 2>&1 || (sudo apt-get update && sudo apt-get install -y zip)

          # ★ 문제의 중복 JAR만 제거 (버전 변경 시 파일명 업데이트 필요)
          zip -d "$WAR_PATH" "WEB-INF/lib/spring-cloud-starter-aws-2.2.6.RELEASE.jar" || true

          echo "Patched WAR: $WAR_PATH"

      - name: Assert WAR exists
        working-directory: backend
        run: ls -al build/libs

      # 3) AWS OIDC 자격 구성 + ECR 로그인
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4) Docker 이미지 빌드 (context=backend, Dockerfile도 backend/에 있어야 함)
      - name: Docker build (context=backend)
        working-directory: backend
        env:
          ECR_REGISTRY: ${{ steps.ecr.outputs.registry }}
        run: |
          docker build --progress=plain \
            -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG_SHA }} \
            -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG_LATEST }} \
            .

      # 5) ECR 푸시
      - name: Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.ecr.outputs.registry }}
        run: |
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG_SHA }}
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG_LATEST }}

      - name: Print image URIs
        env:
          ECR_REGISTRY: ${{ steps.ecr.outputs.registry }}
        run: |
          echo "$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG_SHA }}"
          echo "$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG_LATEST }}"
